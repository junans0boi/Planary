import { useState, useEffect } from "react";
import Calendar from "react-calendar";
import "react-calendar/dist/Calendar.css";
import "../components/Calendar/Calendar.css";
import AddScheduleModal from "../components/Calendar/AddScheduleModal"; // ì¼ì • ì¶”ê°€ ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸
import YearMonthModal from "../components/Calendar/YearMonthSelectModal"; // 
âœ… í•´ì„
â€¢	React Hooks
	â€¢	useState: Reactì˜ ìƒíƒœ ê´€ë¦¬ Hook. ê°’ì´ ë³€ê²½ë  ë•Œ ìë™ìœ¼ë¡œ UIë¥¼ ì—…ë°ì´íŠ¸í•¨.
    âœ… 1. useEffect()ë€?
        â€¢ useEffect()ëŠ” ì»´í¬ë„ŒíŠ¸ê°€ ë Œë”ë§ë  ë•Œ íŠ¹ì • ì‘ì—…(ë¶€ìˆ˜ íš¨ê³¼, Side Effect)ì„ ìˆ˜í–‰í•˜ëŠ” React Hookì…ë‹ˆë‹¤.
        ğŸš€ ì‚¬ìš© ì´ìœ 
	â€¢	ê³µíœ´ì¼ ë°ì´í„°ë¥¼ APIì—ì„œ ê°€ì ¸ì˜¤ë¯€ë¡œ ë„¤íŠ¸ì›Œí¬ ìš”ì²­(fetch)ê³¼ ê°™ì€ ë¹„ë™ê¸° ì‘ì—…ì„ ì²˜ë¦¬í•´ì•¼ í•¨.
	â€¢	API í˜¸ì¶œì„ **í•œ ë²ˆë§Œ ì‹¤í–‰(ì´ˆê¸° ë§ˆìš´íŠ¸ ì‹œ ì‹¤í–‰)**í•˜ê¸° ìœ„í•´ ì˜ì¡´ì„± ë°°ì—´ì„ ë¹ˆ ë°°ì—´ ([])ë¡œ ì„¤ì •.
â€¢	React-Calendar ë¼ì´ë¸ŒëŸ¬ë¦¬
	â€¢	Calendar: ë‹¬ë ¥ì„ í‘œì‹œí•˜ëŠ” ì»´í¬ë„ŒíŠ¸.
	â€¢	import "react-calendar/dist/Calendar.css": ë‹¬ë ¥ì˜ ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì ìš©.
â€¢	ì‚¬ìš©ì ì •ì˜ ì»´í¬ë„ŒíŠ¸
	â€¢	AddScheduleModal: ì¼ì • ì¶”ê°€ ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸.
	â€¢	YearMonthModal: ì—°/ì›” ì„ íƒì„ ìœ„í•œ ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸.
----------------------------------------------------------------------------------------------------------------
function CalendarPage() {
  const [selectedDate, setSelectedDate] = useState(new Date());
  const [holidays, setHolidays] = useState({});
  const [displayYear, setDisplayYear] = useState(new Date().getFullYear());
  const [displayMonth, setDisplayMonth] = useState(new Date().getMonth());
  const [activeStartDate, setActiveStartDate] = useState(new Date());
  const [isYearMonthModalOpen, setIsYearMonthModalOpen] = useState(false);
  const [isScheduleModalOpen, setIsScheduleModalOpen] = useState(false);
  const [isDayClick, setIsDayClick] = useState(false);
  const [schedules, setSchedules] = useState({});

âœ… í•´ì„
	â€¢	selectedDate: í˜„ì¬ ì„ íƒëœ ë‚ ì§œë¥¼ ì €ì¥ (new Date()ë¡œ ì´ˆê¸°í™”).
        â€¢	new Date() : JavaScriptì˜ Date ê°ì²´ëŠ” ë‚ ì§œ ë° ì‹œê°„ì„ ë‹¤ë£° ë•Œ ì‚¬ìš©í•˜ëŠ” ë‚´ì¥ ê°ì²´
        â€¢	í˜„ì¬ ë‚ ì§œì™€ ì‹œê°„ ì¶œë ¥ (ì˜ˆ: 2025-02-18T12:34:56.789Z)

	â€¢	holidays: ê³µíœ´ì¼ ë°ì´í„°ë¥¼ ì €ì¥í•  ê°ì²´ ({} ì´ˆê¸°í™”).
	â€¢	displayYear: í˜„ì¬ í‘œì‹œë˜ëŠ” ì—°ë„ (new Date().getFullYear()ë¡œ ì´ˆê¸°í™”).
        â€¢	new Date() : JavaScriptì˜ Date ê°ì²´ëŠ” ë‚ ì§œ ë° ì‹œê°„ì„ ë‹¤ë£° ë•Œ ì‚¬ìš©í•˜ëŠ” ë‚´ì¥ ê°ì²´
        â€¢	getFullYear() : Date ê°ì²´ì—ì„œ 4ìë¦¬ ì—°ë„(YYYY)ë¥¼ ë°˜í™˜í•˜ëŠ” ë©”ì„œë“œ.
	â€¢	displayMonth: í˜„ì¬ í‘œì‹œë˜ëŠ” ì›” (new Date().getMonth()ë¡œ ì´ˆê¸°í™”, 0~11 ë²”ìœ„).
        â€¢	 getMonth() : Date ê°ì²´ì—ì„œ ì›”(month) ê°’ì„ ë°˜í™˜í•˜ëŠ” ë©”ì„œë“œ, 
        â€¢	 ì›” ê°’ì€ 0ë¶€í„° ì‹œì‘ (0 = 1ì›”, 11 = 12ì›”) â†’ í•­ìƒ +1ì„ í•´ì„œ ì‚¬ìš©í•´ì•¼ í•¨.
	â€¢	activeStartDate: ìº˜ë¦°ë”ê°€ ì‹œì‘í•˜ëŠ” ë‚ ì§œ (í˜„ì¬ ì—°/ì›”ì˜ 1ì¼).
    â€¢	activeStartDate :  ìº˜ë¦°ë”ì—ì„œ í˜„ì¬ í‘œì‹œí•  â€œí•´ë‹¹ ì›”ì˜ ì²«ì§¸ ë‚ â€ì„ ì €ì¥í•˜ëŠ” ìƒíƒœ.
    â€¢	setActiveStartDate : useState()ë¥¼ ì‚¬ìš©í•˜ì—¬ ì •ì˜ëœ ìƒíƒœ ë³€ìˆ˜(activeStartDate)ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜.
	â€¢	isYearMonthModalOpen: ì—°/ì›” ì„ íƒ ëª¨ë‹¬ì˜ ì—´ë¦¼ ì—¬ë¶€ (false ì´ˆê¸°í™”).
	â€¢	isScheduleModalOpen: ì¼ì • ì¶”ê°€ ëª¨ë‹¬ì˜ ì—´ë¦¼ ì—¬ë¶€ (false ì´ˆê¸°í™”).
	â€¢	isDayClick: trueë©´ ë‚ ì§œë¥¼ í´ë¦­í•˜ì—¬ ì¼ì • ì¶”ê°€, falseë©´ í”Œë¡œíŒ… ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì¼ì • ì¶”ê°€.
	â€¢	schedules: ë‚ ì§œë³„ ì¼ì • ë°ì´í„°ë¥¼ ì €ì¥í•  ê°ì²´.
----------------------------------------------------------------------------------------------------------------
  // displayYear, displayMonth ë³€ê²½ ì‹œ ë‹¬ë ¥ í‘œì‹œ
  useEffect(() => {
    setActiveStartDate(new Date(displayYear, displayMonth, 1));
  }, [displayYear, displayMonth]);

âœ… í•´ì„
useEffect()ë€?
	â€¢	useEffect()ëŠ” Reactì˜ Hook ì¤‘ í•˜ë‚˜ë¡œ, ì»´í¬ë„ŒíŠ¸ê°€ ë Œë”ë§ë  ë•Œ íŠ¹ì • ì‘ì—…(ë¶€ìˆ˜ íš¨ê³¼, Side Effect)ì„ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì¤ë‹ˆë‹¤.
    â€¢	setActiveStartDate : useState()ë¥¼ ì‚¬ìš©í•˜ì—¬ ì •ì˜ëœ ìƒíƒœ ë³€ìˆ˜(activeStartDate)ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜.
	â€¢	activeStartDateëŠ” ìº˜ë¦°ë”ì—ì„œ í˜„ì¬ í‘œì‹œí•  â€œí•´ë‹¹ ì›”ì˜ ì²«ì§¸ ë‚ â€ì„ ì €ì¥í•˜ëŠ” ìƒíƒœ.
	â€¢	displayYear ë˜ëŠ” displayMonthê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ìº˜ë¦°ë”ì˜ activeStartDateë¥¼ ì—…ë°ì´íŠ¸.
	â€¢	new Date(displayYear, displayMonth, 1): í•´ë‹¹ ì—°/ì›”ì˜ ì²«ì§¸ ë‚ ì„ ì„¤ì •.
----------------------------------------------------------------------------------------------------------------
  // ê³µíœ´ì¼ ê°€ì ¸ì˜¤ê¸°
  useEffect(() => {
    const fetchHolidays = async () => {
      const year = new Date().getFullYear();
      let fetchedHolidays = {};

      for (let month = 1; month <= 12; month++) {
        try {
          const response = await fetch(
            `http://localhost:5006/api/holidays?year=${year}&month=${month}`
          );
          const data = await response.json();
          const holidaysArray = Array.isArray(data) ? data : data ? [data] : [];
          holidaysArray.forEach((holiday) => {
            const dateStr = holiday.locdate.toString();
            const dateKey = `${dateStr.substring(0, 4)}-${dateStr.substring(4, 6)}-${dateStr.substring(6, 8)}`;
            fetchedHolidays[dateKey] = holiday.dateName;
          });
        } catch (error) {
          console.error("Error fetching holidays:", error);
        }
      }
      setHolidays(fetchedHolidays);
    };
    fetchHolidays();
  }, []);

âœ… í•´ì„
    useEffect(() => { fetchHolidays(); }, []) : ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ ê³µíœ´ì¼ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    fetch() : API í˜¸ì¶œ (ë¹„ë™ê¸°)
    response.json() : JSON ë°ì´í„° ë³€í™˜
    holidaysArray.forEach() : ê³µíœ´ì¼ ë°ì´í„°ë¥¼ { "YYYY-MM-DD": "ê³µíœ´ì¼ëª…" } í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    setHolidays(fetchedHolidays) : ìƒíƒœ ì—…ë°ì´íŠ¸ (UI ë°˜ì˜)

    â€¢	ê³µíœ´ì¼ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” API í˜¸ì¶œ (fetchHolidays í•¨ìˆ˜).
    â€¢	fetch(): REST APIì—ì„œ ê³µíœ´ì¼ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´.
    â€¢	ì‘ë‹µ ë°ì´í„° ì²˜ë¦¬
    â€¢	dataê°€ ë°°ì—´ì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©.
    â€¢	ë°°ì—´ì´ ì•„ë‹ ê²½ìš°, ë‹¨ì¼ ê°ì²´ë¥¼ ë°°ì—´ë¡œ ë³€í™˜í•˜ì—¬ ì²˜ë¦¬.
    â€¢	ë‚ ì§œ ë¬¸ìì—´ì„ ë³€í™˜í•˜ì—¬ holidays ê°ì²´ì— { "YYYY-MM-DD": "ê³µíœ´ì¼ ì´ë¦„" } í˜•íƒœë¡œ ì €ì¥.

----------------------------------------------------------------------------------------------------------------
  // ë…„/ì›” ì„ íƒ ëª¨ë‹¬
  const openYearMonthModal = () => setIsYearMonthModalOpen(true);
  const closeYearMonthModal = () => setIsYearMonthModalOpen(false);
  const handleYearMonthSelect = (year, month) => {
    setDisplayYear(year);
    setDisplayMonth(month-1);
  };
âœ… í•´ì„
  	â€¢	openYearMonthModal(): ì—°/ì›” ì„ íƒ ëª¨ë‹¬ì„ ì—¼.
	â€¢	closeYearMonthModal(): ì—°/ì›” ì„ íƒ ëª¨ë‹¬ì„ ë‹«ìŒ.
	â€¢	handleYearMonthSelect(year, month): ì„ íƒëœ ì—°/ì›”ì„ ë°˜ì˜. (month - 1ì„ í†µí•´ 0ë¶€í„° ì‹œì‘í•˜ëŠ” ì›” ê°’ìœ¼ë¡œ ë³€í™˜)

----------------------------------------------------------------------------------------------------------------
  // ì¼ì • ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
  // (1) ë‹¬ë ¥ ë‚ ì§œ í´ë¦­ â†’ í•´ë‹¹ ë‚ ì§œ 00:00~23:59
  const handleDayClick = (date) => {
    setSelectedDate(date);
    setIsDayClick(true);   // ë‹¬ë ¥ ë‚ ì§œ í´ë¦­
    setIsScheduleModalOpen(true);
  };

  // (2) í”Œë¡œíŒ… ë²„íŠ¼ í´ë¦­ â†’ ì˜¤ëŠ˜ ë‚ ì§œ 00:00~23:59
  const openScheduleModal = () => {
    setSelectedDate(new Date());
    setIsDayClick(false);  // í”Œë¡œíŒ… ë²„íŠ¼ í´ë¦­
    setIsScheduleModalOpen(true);
  };

  // ì¼ì • ëª¨ë‹¬ ë‹«ê¸°
  const closeScheduleModal = () => setIsScheduleModalOpen(false);

âœ… í•´ì„
	â€¢	handleDayClick(date): ë‹¬ë ¥ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ë‚ ì§œì— ëŒ€í•œ ì¼ì • ì¶”ê°€ ëª¨ë‹¬ì„ ì—´ìŒ.
	â€¢	openScheduleModal(): í”Œë¡œíŒ… ë²„íŠ¼ í´ë¦­ ì‹œ ì˜¤ëŠ˜ ë‚ ì§œì˜ ì¼ì • ì¶”ê°€ ëª¨ë‹¬ì„ ì—´ìŒ.
	â€¢	closeScheduleModal(): ì¼ì • ì¶”ê°€ ëª¨ë‹¬ì„ ë‹«ìŒ.
----------------------------------------------------------------------------------------------------------------
  /**
   * (ì¤‘ìš”) ì¼ì • ì €ì¥ ë¡œì§
   * => startTime ~ endTime ë²”ìœ„ì˜ ëª¨ë“  ë‚ ì§œì— ìŠ¤ì¼€ì¤„ì„ ë“±ë¡
   */
  const handleScheduleSave = (schedule) => {
    console.log("ì €ì¥ëœ ì¼ì •:", schedule);

    // ìƒˆ schedules ê°ì²´ë¥¼ ë§Œë“¤ê³ ,
    const newSchedules = { ...schedules };

    const start = new Date(schedule.startTime);
    const end = new Date(schedule.endTime);

    // ë‚ ì§œ ë°˜ë³µë¬¸ (start <= end)
    let current = new Date(start);
    while (current <= end) {
      const dateKey = current.toISOString().split("T")[0];
      // í•´ë‹¹ ë‚ ì§œì— ì´ë¯¸ ì¼ì •ì´ ìˆìœ¼ë©´ ë°°ì—´ì— ì¶”ê°€, ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
      if (!newSchedules[dateKey]) {
        newSchedules[dateKey] = [schedule];
      } else {
        newSchedules[dateKey].push(schedule);
      }
      // í•˜ë£¨ì”© ì¦ê°€
      current.setDate(current.getDate() + 1);
    }

    setSchedules(newSchedules);
  };

  return (
    <div className="calendar-container">
      {/* ìƒë‹¨ í—¤ë” */}
      <div
        className="calendar-header"
        onClick={openYearMonthModal}
        style={{ cursor: "pointer", textAlign: "left" }}
      >
        <h2>
          {displayYear}ë…„ {displayMonth + 1}ì›”
        </h2>
      </div>

      {/* ì—°/ì›” ì„ íƒ ëª¨ë‹¬ */}
      {isYearMonthModalOpen && (
        <YearMonthModal
          currentYear={displayYear}
          currentMonth={displayMonth}
          onClose={closeYearMonthModal}
          onSelect={handleYearMonthSelect}
        />
      )}

      {/* ì¼ì • ì¶”ê°€ ëª¨ë‹¬ */}
      {isScheduleModalOpen && (
        <AddScheduleModal
          onClose={closeScheduleModal}
          onSave={handleScheduleSave}
          selectedDate={selectedDate}
          isDayClick={isDayClick} // ë‹¬ë ¥ í´ë¦­ or í”Œë¡œíŒ… ë²„íŠ¼ í´ë¦­ ì—¬ë¶€
        />
      )}

      {/* ë‹¬ë ¥ */}
      <Calendar
        onChange={setSelectedDate}
        value={selectedDate}
        calendarType="gregory"
        view="month"
        navigationLabel={null}
        prevLabel={null}
        nextLabel={null}
        prev2Label={null}
        next2Label={null}
        showNeighboringMonth={true}
        activeStartDate={activeStartDate}
        onActiveStartDateChange={({ activeStartDate }) =>
          setActiveStartDate(activeStartDate)
        }
        formatDay={(locale, date) => date.getDate().toString()}
        tileClassName={({ date, view }) => {
          if (view === "month") {
            const dateString = date.toISOString().split("T")[0];
            const day = date.getDay();

            // ì´ì›ƒ ì›”
            if (date.getMonth() !== activeStartDate.getMonth()) {
              return "neighboring-month";
            }
            // ì¼ìš”ì¼
            if (day === 0) return "sunday";
            // í† ìš”ì¼
            if (day === 6) return "saturday";
            // ê³µíœ´ì¼
            if (holidays[dateString]) return "holiday";
          }
          return null;
        }}
        tileContent={({ date, view }) => {
          if (view === "month") {
            const dateString = date.toISOString().split("T")[0];
            const daySchedules = schedules[dateString] || [];

            return (
              <>
                {/* ê³µíœ´ì¼ ë¼ë²¨ */}
                {holidays[dateString] && (
                  <span className="holiday-tooltip">
                    {holidays[dateString]}
                  </span>
                )}
                {/* ì¼ì • ë¼ë²¨ (ë‹¤ì¤‘ ë‚ ì§œ ì§€ì›) */}
                {daySchedules.map((sch, idx) => (
                  <div key={idx} className="schedule-label">
                    {sch.title}
                  </div>
                ))}
              </>
            );
          }
          return null;
        }}
        onClickDay={handleDayClick}
      />

      {/* ì„ íƒëœ ë‚ ì§œ í‘œì‹œ (í…ŒìŠ¤íŠ¸ìš©) */}
      <p className="selected-date">ì„ íƒí•œ ë‚ ì§œ: {selectedDate.toDateString()}</p>

      {/* ìš°ì¸¡ í•˜ë‹¨ í”Œë¡œíŒ… ë²„íŠ¼ */}
      <button className="floating-btn" onClick={openScheduleModal}>
        +
      </button>
    </div>
  );
}

export default CalendarPage;